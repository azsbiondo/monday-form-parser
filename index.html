<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form Parser</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/monday-sdk-js/dist/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fast-xml-parser@4.5.0/dist/browser/fast-xml-parser.min.js"></script>
<style>
:root{--bg:#0b0c0f;--card:rgba(255,255,255,.06);--text:#eaeef6;--muted:#aab2c5;--accent:#3d6317;--accent-2:#24468E;--ring:rgba(36,70,142,.35);--border:rgba(255,255,255,.12);--shadow:0 10px 25px rgba(0,0,0,.35)}
@media (prefers-color-scheme: light){:root{--bg:#f6f7fb;--card:#ffffff;--text:#0b0c0f;--muted:#5a6173;--accent:#3d6317;--accent-2:#24468E;--ring:rgba(36,70,142,.22);--border:rgba(10,12,16,.08);--shadow:0 10px 25px rgba(10,12,16,.08)}}
html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 600px at 20% -10%,rgba(36,70,142,.25),transparent 60%),radial-gradient(900px 450px at 120% 20%,rgba(61,99,23,.20),transparent 60%),var(--bg);color:var(--text)}
.container{max-width:980px;margin:24px auto;padding:0 20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.title{font-size:20px;font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:linear-gradient(135deg,var(--accent-2),var(--accent));color:#fff}
.panel{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:14px 14px 0 14px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));color:var(--text);border:1px solid var(--border);transition:transform .05s ease,box-shadow .2s ease,border-color .2s ease}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.18)}
.btn.primary{background:linear-gradient(135deg,var(--accent-2),var(--accent));color:#fff;border-color:transparent}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.statusline{font-size:12px;color:var(--muted);padding:0 14px 10px 14px}
.body{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:14px}
@media (max-width:940px){.body{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:14px;padding:14px;min-height:180px}
.card h2{font-size:14px;margin:0 0 10px 0;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}
.drop{display:flex;align-items:center;justify-content:center;text-align:center;border:2px dashed var(--border);border-radius:14px;height:156px;padding:10px;transition:border-color .2s ease,background .2s ease}
.drop.k{border-color:var(--accent-2);background:rgba(36,70,142,.06)}
.preview{max-height:310px;overflow:auto}
.row{display:grid;grid-template-columns:200px 1fr;gap:10px;padding:8px;border-bottom:1px dashed var(--border)}
.key{font-weight:700}
.val{color:var(--text)}
.kv-empty{color:var(--muted)}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpill{font-size:12px;border-radius:999px;padding:6px 10px;border:1px solid var(--border);color:var(--muted)}
.footer-note{font-size:11px;color:var(--muted);padding:10px 14px 16px 14px}
hr.sep{border:0;border-top:1px solid var(--border);margin:10px 0}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">Form → Columns <span class="badge">Item View</span></div>
    <div class="kpi">
      <div class="kpill" id="theme-pill">Theme: auto</div>
      <div class="kpill" id="ctx-pill">Board: — | Item: —</div>
    </div>
  </div>
  <div class="panel">
    <div class="toolbar">
      <div class="actions">
        <button class="btn" id="extract">Extract from attachment</button>
        <button class="btn primary" id="apply" disabled>Apply to item</button>
      </div>
      <div class="actions">
        <button class="btn" id="choose">Choose .docx</button>
      </div>
    </div>
    <div class="statusline" id="msg">Drop a .docx below or extract from the attached file.</div>
    <div class="body">
      <div class="card">
        <h2>Dropzone</h2>
        <div id="dropzone" class="drop">Drag & drop a .docx here</div>
        <input id="fileinput" type="file" accept=".docx" style="display:none">
        <hr class="sep">
        <div class="footer-note">Processing occurs in your browser. No files are sent anywhere except updates to this Monday item’s columns.</div>
      </div>
      <div class="card">
        <h2>Preview</h2>
        <div id="preview" class="preview kv-empty">No fields extracted yet.</div>
      </div>
    </div>
  </div>
</div>
<script>
const mapping={
  "Group":{"type":"status","columnId":"status06"},
  "Value":{"type":"numbers","columnId":"numeric_mkq0534"},
  "Team_Lead":{"type":"text","columnId":"executive___ops_2"},
  "Team_Est":{"type":"text","columnId":"text8"}
}
const monday=mondaySdk()
let ctx=null,itemId=null,boardId=null,rawFields=null,updates=null,assetUrl=null,pendingName=null
function setMsg(t){document.getElementById("msg").innerText=t||""}
function normText(s){return (s||"").trim()}
function normDate(s){if(!s)return null;const d=new Date(s);if(isNaN(d))return null;return d.toISOString().slice(0,10)}
function parseTimeToHHMM(s){
  if(!s) return null
  const str=String(s).trim()
  const m=str.match(/^(\d{1,2})(?::?(\d{2}))?\s*([AaPp][Mm])?$/)
  if(!m){const d=new Date("1970-01-01T"+str);if(!isNaN(d))return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");return null}
  let hh=parseInt(m[1],10),mm=m[2]?parseInt(m[2],10):0,ap=m[3]?.toLowerCase?.()
  if(ap==="pm"&&hh<12)hh+=12;if(ap==="am"&&hh===12)hh=0
  if(hh<0||hh>23||mm<0||mm>59)return null
  return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0")
}
function xmlGetText(node){
  if(node==null)return ""
  if(typeof node==="string")return node
  if(Array.isArray(node))return node.map(xmlGetText).join("")
  let out=""
  for(const k in node){
    if(k==="w:t"||k==="t") out+=xmlGetText(node[k])
    else if(k==="w:r"||k==="r"||k==="w:p"||k==="p"||k==="w:br"||k==="br") out+=xmlGetText(node[k])
    else if(typeof node[k]==="object") out+=xmlGetText(node[k])
  }
  return out
}
function extractSdt(doc){
  const parser=new window.XMLParser({ignoreAttributes:false,attributeNamePrefix:"",removeNSPrefix:true})
  const j=parser.parse(doc)
  const body=((j||{}).document||{}).body
  const sdts=[]
  function walk(n){if(!n||typeof n!=="object")return;if(n.sdt){const a=n.sdt;Array.isArray(a)?a.forEach(x=>sdts.push(x)):sdts.push(a)}for(const k in n){if(n[k]&&typeof n[k]==="object")walk(n[k])}}
  walk(body)
  const out={}
  sdts.forEach(s=>{const pr=s.sdtPr||{};let tag=null;if(pr.tag&&pr.tag.val)tag=pr.tag.val;if(!tag&&pr.alias&&pr.alias.val)tag=pr.alias.val;const val=xmlGetText(s.sdtContent);if(tag)out[tag]=normText(val)})
  return out
}
async function getAssetUrl(){
  const q=`query($itemIds:[Int!]){items(ids:$itemIds){id assets{id name public_url}}}`
  const r=await monday.api(q,{variables:{itemIds:[itemId]}})
  const assets=((r||{}).data||{}).items?.[0]?.assets||[]
  const doc=assets.find(a=>/\.docx$/i.test(a.name))||assets[0]
  return doc?doc.public_url:null
}
async function fetchDoc(url){
  const res=await fetch(url)
  const ab=await res.arrayBuffer()
  const zip=await JSZip.loadAsync(ab)
  const file=zip.file("word/document.xml")
  if(!file)return null
  return await file.async("string")
}
async function parseDocxArrayBuffer(ab){
  const zip=await JSZip.loadAsync(ab)
  const file=zip.file("word/document.xml")
  if(!file)return null
  return await file.async("string")
}
function previewFields(fields){
  const el=document.getElementById("preview")
  const keys=Object.keys(fields||{}).sort()
  if(!keys.length){el.classList.add("kv-empty");el.innerHTML="No fields extracted yet.";return}
  el.classList.remove("kv-empty")
  el.innerHTML=keys.map(k=>`<div class="row"><div class="key">${k}</div><div class="val">${fields[k]||""}</div></div>`).join("")
}
function buildTitle(fields){
  const a=normText(fields.ENumber),b=normText(fields.Name_Client),c=normText(fields.Name_Project)
  const parts=[a,b,c].filter(Boolean)
  return parts.length?parts.join(" "):null
}
async function buildUpdates(fields){
  const vals={}
  pendingName=buildTitle(fields)||null
  const rawDate=normText(fields.Due_Date)
  const rawTime=normText(fields.Due_Time)
  const dateIso=normDate(rawDate)
  const hhmm=parseTimeToHHMM(rawTime)
  if(dateIso){vals["date6"]=hhmm?{"date":dateIso,"time":hhmm}:{"date":dateIso}}
  for(const k in mapping){
    const m=mapping[k],v=fields[k]
    if(v==null||v==="")continue
    if(m.type==="text"){vals[m.columnId]=v}
    else if(m.type==="numbers"){const n=Number(String(v).replace(/[^0-9.\-]/g,""));if(!isNaN(n))vals[m.columnId]=String(n)}
    else if(m.type==="status"){vals[m.columnId]={"label":v}}
  }
  return vals
}
async function applyToMonday(vals){
  const s=JSON.stringify(vals).replace(/"/g,'\\"')
  const m=`mutation($bid:Int!,$iid:Int!){change_multiple_column_values(board_id:$bid,item_id:$iid,column_values:"${s}"){id}}`
  await monday.api(m,{variables:{bid:Number(boardId),iid:Number(itemId)}})
  if(pendingName){
    try{
      const m2=`mutation($iid:Int!,$val:String!){change_simple_column_value(item_id:$iid,column_id:"name",value:$val){id}}`
      await monday.api(m2,{variables:{iid:Number(itemId),val:JSON.stringify(pendingName)}})
    }catch(e){
      const m3=`mutation($iid:Int!,$name:String!){change_item_name(item_id:$iid,name:$name){id}}`
      await monday.api(m3,{variables:{iid:Number(itemId),name:pendingName}})
    }
  }
}
monday.listen("context",(res)=>{ctx=res.data||{};itemId=ctx.itemId;boardId=ctx.boardId;document.getElementById("ctx-pill").innerText=`Board: ${boardId||"—"} | Item: ${itemId||"—"}`})
monday.listen("theme",(res)=>{const theme=res.data?.theme||"auto";document.getElementById("theme-pill").innerText=`Theme: ${theme}`})
const dz=document.getElementById("dropzone"),fi=document.getElementById("fileinput")
document.getElementById("choose").onclick=()=>fi.click()
fi.addEventListener("change",e=>{const f=e.target.files?.[0];if(f&&/\.docx$/i.test(f.name))handleLocalFile(f)})
dz.addEventListener("dragover",e=>{e.preventDefault();dz.classList.add("k")})
dz.addEventListener("dragleave",e=>{e.preventDefault();dz.classList.remove("k")})
dz.addEventListener("drop",e=>{e.preventDefault();dz.classList.remove("k");const f=e.dataTransfer.files?.[0];if(!f){setMsg("No file dropped");return}if(!/\.docx$/i.test(f.name)){setMsg("Please drop a .docx file");return}handleLocalFile(f)})
async function handleLocalFile(file){
  setMsg("Reading local .docx…")
  const ab=await file.arrayBuffer()
  const xml=await parseDocxArrayBuffer(ab)
  if(!xml){setMsg("Invalid .docx");return}
  rawFields=extractSdt(xml)
  previewFields(rawFields)
  updates=await buildUpdates(rawFields)
  document.getElementById("apply").disabled=Object.keys(updates||{}).length===0&&!buildTitle(rawFields)
  setMsg((Object.keys(updates||{}).length||buildTitle(rawFields))?"Ready to apply":"Nothing mappable found")
}
document.getElementById("extract").onclick=async()=>{
  setMsg("Fetching attachment…")
  assetUrl=await getAssetUrl()
  if(!assetUrl){setMsg("No attachment found in this item");return}
  setMsg("Reading .docx…")
  const xml=await fetchDoc(assetUrl)
  if(!xml){setMsg("Invalid .docx");return}
  rawFields=extractSdt(xml)
  previewFields(rawFields)
  updates=await buildUpdates(rawFields)
  document.getElementById("apply").disabled=Object.keys(updates||{}).length===0&&!buildTitle(rawFields)
  setMsg((Object.keys(updates||{}).length||buildTitle(rawFields))?"Ready to apply":"Nothing mappable found")
}
document.getElementById("apply").onclick=async()=>{
  const nameCandidate=buildTitle(rawFields)
  if(!updates&&!nameCandidate){setMsg("Nothing to apply");return}
  setMsg("Updating item…")
  await applyToMonday(updates||{})
  setMsg("Done")
}
</script>
</body>
</html>
