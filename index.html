<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Update Item — status06 & date6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Monday SDK: CDN only -->
  <script src="https://unpkg.com/monday-sdk-js/dist/main.js"></script>
  <style>
    /* ---------- Base + Dark Mode ---------- */
    :root{
      --bg: #f6f7f9;
      --card: #ffffff;
      --text: #1f1f1f;
      --muted: #5f6a79;
      --border: #e6e8ec;
      --brand: #1f7a54;
      --brand-600:#156346;
      --brand-050:#f0fff7;
      --warn:#b54708;
      --ok:#177245;
      --shadow: 0 6px 18px rgba(16,24,40,0.08);
      --radius: 14px;
      --gap: 14px;
      --input-h: 38px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0f141a;
        --card: #151b23;
        --text: #e6edf3;
        --muted: #9aa7b5;
        --border: #2a3441;
        --brand: #3dd68c;
        --brand-600:#27b06f;
        --brand-050:#0f1f19;
        --warn:#ffb020;
        --ok:#36d399;
        --shadow: 0 6px 18px rgba(0,0,0,0.45);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:24px;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); background: var(--bg);
    }

    /* ---------- Layout ---------- */
    .wrap{max-width:1060px; margin:0 auto; display:grid; gap: var(--gap); grid-template-columns: 1.2fr .8fr}
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr } }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .card h2{margin:0 0 4px; font-size:18px}
    .sub{color:var(--muted); margin-bottom:10px}

    /* ---------- Dropzone ---------- */
    .dz{
      border:1.5px dashed var(--border);
      border-radius: calc(var(--radius) - 2px);
      padding: 22px 18px;
      background: linear-gradient(0deg, rgba(127,127,127,.04), rgba(127,127,127,.04));
      display:flex; align-items:center; gap:14px; cursor:pointer; transition: .18s ease;
      min-height: 84px;
    }
    .dz.dragover{ border-color: var(--brand); background: var(--brand-050); }
    .dz .icon{width:34px; height:34px; border-radius:10px; background: var(--brand); display:grid; place-items:center; color:#fff}
    .dz .copy{display:flex; flex-direction:column; gap:4px}
    .dz .title{font-weight:600}
    .dz .hint{color:var(--muted)}

    textarea{
      width:100%; min-height: 120px;
      border:1px solid var(--border); background:transparent; color:var(--text);
      border-radius: 10px; padding:10px; resize:vertical; outline:none;
    }
    textarea:focus{ box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 25%, transparent); border-color: var(--brand-600); }

    /* ---------- Form ---------- */
    .grid{display:grid; gap: var(--gap)}
    .row{display:flex; gap: var(--gap); flex-wrap:wrap}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="date"], select{
      height: var(--input-h);
      padding: 0 10px; border-radius: 10px;
      border:1px solid var(--border); background: transparent; color: var(--text); outline:none;
      min-width: 160px;
    }
    input[type="text"]:focus, input[type="date"]:focus, select:focus{
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 25%, transparent); border-color: var(--brand-600);
    }

    .btn{
      height: 40px; padding: 0 14px; border-radius: 10px; border:1px solid transparent; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px; font-weight:600;
    }
    .btn.primary{ background: var(--brand); color:#0b1510; }
    .btn.primary:disabled{ opacity:.6; cursor:not-allowed }
    .btn.ghost{ background: transparent; border-color: var(--border); color: var(--text) }
    .btn.low{ background: color-mix(in srgb, var(--brand) 18%, transparent); color: var(--brand-600) }

    .muted{color:var(--muted)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
      background: color-mix(in srgb, var(--brand) 14%, transparent); color: var(--brand-600); font-size:12px}
    .spacer{flex:1}

    details{border-top:1px dashed var(--border); padding-top:10px; margin-top:8px}
    pre{margin:8px 0 0; background: #0b0b0b10; padding:10px; border-radius:8px; overflow:auto}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Input / Dropzone -->
    <section class="card">
      <h2>Quick capture</h2>
      <div class="sub">Drag in a file or paste text/JSON. We’ll try to detect status, date & time.</div>

      <div id="dz" class="dz" tabindex="0" aria-label="Drop a file or click to paste">
        <div class="icon" aria-hidden="true">
          <!-- paper icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M8 2h5l5 5v13a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="1.5" fill="none"/><path d="M13 2v5h5" stroke="#fff" stroke-width="1.5"/></svg>
        </div>
        <div class="copy">
          <div class="title">Drop file / click to paste</div>
          <div class="hint">Accepts plain text or JSON (e.g. { "status":"Done", "date":"2025-09-15", "time":"13:00" })</div>
        </div>
        <div class="spacer"></div>
        <span class="pill">status06</span>
        <span class="pill">date6</span>
      </div>

      <div class="grid" style="margin-top:12px">
        <textarea id="paste" placeholder="Or paste here…"></textarea>
        <div class="row">
          <button id="btnParse" class="btn ghost">Extract from input</button>
          <button id="btnClear" class="btn ghost">Clear</button>
          <span id="hintL" class="muted"></span>
        </div>
      </div>

      <details id="extractPanel" style="margin-top:6px">
        <summary class="muted">Extracted preview</summary>
        <div id="extractOut" class="muted"><em>Nothing yet.</em></div>
      </details>
    </section>

    <!-- RIGHT: Controls & Apply -->
    <section class="card">
      <h2>Set values</h2>
      <div class="sub">24-hour time; minutes 00 or 30; seconds forced to 00; time only if Date column allows it.</div>

      <div class="grid">
        <div>
          <label>Status label (status06)</label><br/>
          <input id="statusLabel" type="text" placeholder="e.g., Done / In progress / Stuck" />
          <div class="muted" style="margin-top:4px">Will validate against the board’s labels.</div>
        </div>

        <div class="row">
          <div>
            <label>Date (date6)</label><br/>
            <input id="dateOnly" type="date" />
          </div>

          <div>
            <label>Hour (24h)</label><br/>
            <select id="hour"><option value="">—</option></select>
          </div>

          <div>
            <label>Minute</label><br/>
            <select id="minute">
              <option value="">—</option>
              <option value="00">00</option>
              <option value="30">30</option>
            </select>
          </div>
        </div>

        <div class="row" style="align-items:center">
          <button id="btnApply" class="btn primary">Apply to item</button>
          <button id="btnLabels" class="btn low" type="button">Show status labels</button>
          <span id="hintR" class="muted"></span>
        </div>

        <details>
          <summary class="muted">Log</summary>
          <div id="out" class="muted"></div>
        </details>
      </div>
    </section>
  </div>

<script>
/* ================= Monday SDK & Helpers ================= */
const monday = window.mondaySdk();
const $ = id => document.getElementById(id);
const write = (html, cls="")=>{
  const d=$("out"), x=document.createElement("div");
  x.className=cls; x.innerHTML=html; d.appendChild(x);
};
const j = o => JSON.stringify(o,null,2);

let ctx=null, boardColumns=null;

monday.listen("context", ({data})=>{
  ctx = data;
  $("hintL").textContent = "Ready";
  $("hintR").textContent = "";
});

/* ================= Populate hour dropdown (00..23) ================= */
(function fillHours(){
  const sel = $("hour");
  for(let h=0; h<24; h++){
    const v = String(h).padStart(2,"0");
    const opt = document.createElement("option");
    opt.value=v; opt.textContent=v; sel.appendChild(opt);
  }
})();

/* ================= Board schema helpers ================= */
async function ensureColumns(boardId){
  if(boardColumns) return boardColumns;
  const q=`
    query($ids:[ID!]){
      boards(ids:$ids){
        id
        columns{ id title type settings_str }
      }
    }`;
  const res = await monday.api(q,{variables:{ids:String(boardId)}});
  if(res.errors) throw new Error(res.errors[0].message);
  boardColumns = res.data.boards?.[0]?.columns || [];
  return boardColumns;
}
function parseStatusLabels(settings_str){
  try{
    const s=JSON.parse(settings_str||"{}");
    const labels = s.labels || s.labels_positions || {};
    return Object.values(labels).filter(Boolean).map(String);
  }catch{ return []; }
}
function isDateTimeEnabled(settings_str){
  try{
    const s=JSON.parse(settings_str||"{}");
    return Boolean(s.time || s.enable_time || s.allow_time);
  }catch{ return false; }
}
function buildDateValue(settings_str, dateISO, hh, mm){
  if(!dateISO) return null;
  const allowTime = isDateTimeEnabled(settings_str);
  if(!allowTime) return { date: dateISO };
  if(hh){
    const hour = hh.padStart(2,"0");
    const minute = (mm || "00").padStart(2,"0");
    return { date: dateISO, time: `${hour}:${minute}:00` };
  }
  return { date: dateISO };
}

/* ================= Dropzone, paste, and extraction ================= */
const dz = $("dz"), paste=$("paste");
const extractPanel=$("extractPanel"), extractOut=$("extractOut");

function setDz(on){ dz.classList.toggle("dragover", !!on); }
function clearAll(){
  paste.value=""; extractOut.innerHTML="<em>Nothing yet.</em>"; extractPanel.open=false;
  $("statusLabel").value=""; $("dateOnly").value=""; $("hour").value=""; $("minute").value="";
  $("out").innerHTML=""; $("hintL").textContent=""; $("hintR").textContent="";
}
dz.addEventListener("dragover",(e)=>{ e.preventDefault(); setDz(true); });
dz.addEventListener("dragleave",()=> setDz(false));
dz.addEventListener("drop", async (e)=>{
  e.preventDefault(); setDz(false);
  try{
    const dt=e.dataTransfer;
    let text="";
    if(dt.files && dt.files.length){ text = await fileToText(dt.files[0]); }
    else if(dt.getData){ text = dt.getData("text") || ""; }
    paste.value = text;
    $("btnParse").click();
  }catch(err){ showExtract({ error:String(err) }); }
});
dz.addEventListener("click",()=> paste.focus());
$("btnClear").addEventListener("click", clearAll);

function fileToText(file){
  return new Promise((res,rej)=>{
    const r=new FileReader(); r.onload=()=>res(String(r.result||"")); r.onerror=()=>rej(r.error||new Error("Read failed")); r.readAsText(file);
  });
}
function showExtract(o){
  extractOut.innerHTML = `<pre>${j(o)}</pre>`;
  extractPanel.open = true;
}
function extractFields(raw, allowed){
  const txt=String(raw||"");
  let status=null, dateISO=null, hour=null, minute=null;

  // Try JSON
  try{
    const obj=JSON.parse(txt);
    if(typeof obj==="object"){
      const st = obj.status || obj.Status || obj.label || obj.status_label;
      if(st && typeof st==="string") status=st.trim();

      const d = obj.date || obj.Date || obj.date6 || obj.dateOnly;
      if(d && /^\d{4}-\d{2}-\d{2}$/.test(d)) dateISO=d;

      const t = obj.time || obj.Time || obj.time24 || obj.time_str;
      if(t && /^\d{2}:\d{2}/.test(t)){
        const [hh,mm] = String(t).split(":");
        hour = hh.padStart(2,"0"); minute = (mm==="30"?"30":"00");
      }
    }
  }catch{}

  // Fallback: regex scan
  if(!dateISO){
    const m = txt.match(/\b(20\d{2})[-/.](\d{1,2})[-/.](\d{1,2})\b/);
    if(m){ dateISO = `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`; }
  }
  if(!hour){
    const t = txt.match(/\b([01]?\d|2[0-3]):([0-5]\d)\b/);
    if(t){ hour = String(t[1]).padStart(2,"0"); minute = (t[2]==="30")?"30":"00"; }
  }
  if(!status && allowed?.length){
    const low = txt.toLowerCase();
    status = allowed.find(l=> low.includes(String(l).toLowerCase()) ) || null;
  }
  return { status, dateISO, hour, minute };
}

$("btnParse").addEventListener("click", async ()=>{
  try{
    $("hintL").textContent = "Scanning…";
    if(!ctx?.boardId) throw new Error("Open inside an item to load board schema.");
    const cols = await ensureColumns(ctx.boardId);
    const statusCol = cols.find(c=>c.id==="status06");
    const dateCol   = cols.find(c=>c.id==="date6");
    const allowed = statusCol ? parseStatusLabels(statusCol.settings_str) : [];

    const res = extractFields(paste.value, allowed);
    if(res.status) $("statusLabel").value = res.status;
    if(res.dateISO) $("dateOnly").value = res.dateISO;
    if(res.hour) $("hour").value = res.hour;
    if(res.minute) $("minute").value = (res.minute==="30"?"30":"00");

    showExtract({
      detected: res,
      meta: {
        statusMatchedAgainst: allowed,
        dateTimeEnabled: dateCol ? isDateTimeEnabled(dateCol.settings_str) : null
      }
    });
  }catch(e){
    showExtract({ error: e?.message||String(e) });
  }finally{
    $("hintL").textContent = "";
  }
});

/* ================= Apply ================= */
async function applyValues(){
  $("hintR").textContent = "Applying…";
  $("btnApply").disabled = true;
  $("out").innerHTML = "";

  try{
    if(!ctx?.boardId || !ctx?.itemId) throw new Error("Open this page inside a Monday item view.");
    const boardId = ctx.boardId, itemId = ctx.itemId;
    const cols = await ensureColumns(boardId);

    const statusCol = cols.find(c=>c.id==="status06");
    const dateCol   = cols.find(c=>c.id==="date6");
    if(!dateCol) throw new Error('Column "date6" not found on this board.');

    const vals = {};

    // Status (optional)
    const labelIn = ($("statusLabel").value||"").trim();
    if(statusCol && labelIn){
      const allowed = parseStatusLabels(statusCol.settings_str).map(x=>x.toLowerCase());
      if(allowed.includes(labelIn.toLowerCase())){
        vals["status06"] = { label: labelIn };
      }else{
        write(`Skipping status: "<b>${labelIn}</b>" not found among board labels.`, "warn");
      }
    }

    // Date (+ optional time if allowed)
    const dateISO = ($("dateOnly").value||"").trim();
    const hh = ($("hour").value||"").trim();
    const mm = ($("minute").value||"").trim();
    const dateVal = buildDateValue(dateCol.settings_str, dateISO, hh, mm);
    if(dateVal) vals["date6"] = dateVal;

    if(Object.keys(vals).length===0){
      write(`Nothing to update. Provide Status and/or Date.`, "warn");
      return;
    }

    // Send change_multiple_column_values
    const m = `
      mutation($bid:ID!,$iid:ID!,$vals:JSON!){
        change_multiple_column_values(board_id:$bid, item_id:$iid, column_values:$vals){ id }
      }`;
    const variables = { bid:String(boardId), iid:String(itemId), vals: JSON.stringify(vals) };

    write(`<details><summary>column_values</summary><pre>${j(vals)}</pre></details>`);
    const r = await monday.api(m,{variables});
    if(r.errors) throw new Error(r.errors[0].message);

    write(`<b class="ok">✅ Update succeeded</b>`,"ok");
  }catch(e){
    write(`<b class="warn">❌ ${e?.message||e}</b>`,"warn");
  }finally{
    $("btnApply").disabled = false;
    $("hintR").textContent = "";
  }
}

$("btnApply").addEventListener("click", applyValues);

/* Show allowed labels helper */
$("btnLabels").addEventListener("click", async ()=>{
  try{
    if(!ctx?.boardId) return;
    const cols = await ensureColumns(ctx.boardId);
    const statusCol = cols.find(c=>c.id==="status06");
    const labels = parseStatusLabels(statusCol?.settings_str||"");
    write(`<details open><summary>Status labels (status06)</summary><pre>${j(labels)}</pre></details>`);
  }catch(e){
    write(`Couldn’t load labels: ${e?.message||e}`,"warn");
  }
});
</script>
</body>
</html>
