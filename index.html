<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>monday updater (fixed mondaySdk init)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; padding: 24px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
  </style>
  <!-- Load the UMD build; it exposes window.mondaySdk -->
  <script src="https://unpkg.com/monday-sdk-js/dist/main.js" defer></script>
</head>
<body>
  <h1>Update item columns</h1>
  <p>JSON path first; falls back to String if needed.</p>
  <button id="applyBtn">Apply to monday</button>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // âœ… Correct: window.mondaySdk() (NOT window.mondaySDK)
      const monday = window.mondaySdk();

      // ------- config you can tweak -------
      const HARDCODED_TOKEN = ""; // leave empty to use session token

      function buildColumnValues() {
        const isoToday = new Date().toISOString().slice(0, 10);
        return {
          status52: { index: 2 },    // change to your column ids/values
          date6: { date: isoToday },
        };
      }
      // ------------------------------------

      async function getAuthToken() {
        if (HARDCODED_TOKEN) return HARDCODED_TOKEN;
        const { data: token } = await monday.get("sessionToken");
        return token;
      }

      async function getContext() {
        const { data } = await monday.get("context");
        return {
          boardId: data?.boardId || data?.boardIds?.[0],
          itemId: data?.itemId,
        };
      }

      async function runGql(tag, query, variables) {
        const token = await getAuthToken();
        const res = await fetch("https://api.monday.com/v2", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": token,
          },
          body: JSON.stringify({ query, variables }),
        });
        const json = await res.json();
        if (json.errors?.length) {
          console.log("There was an error in response from monday.com graphql API: ", json.errors);
          const e = new Error("Graphql validation errors");
          e.graphQLErrors = json.errors;
          throw e;
        }
        console.log(`[GQL:${tag}]`, json);
        return json.data;
      }

      async function applyToMonday() {
        try {
          const { boardId, itemId } = await getContext();
          if (!boardId || !itemId) {
            alert("Open this inside an item so I can read boardId/itemId.");
            return;
          }

          const cleaned = buildColumnValues();
          console.log("[Payload] cleaned object:", cleaned);

          // --- JSON first
          const mJson = `
            mutation($bid: ID!, $iid: ID!, $vals: JSON!) {
              change_multiple_column_values(board_id: $bid, item_id: $iid, column_values: $vals) { id }
            }`;
          try {
            await runGql("set-columns(JSON)", mJson, {
              bid: String(boardId),
              iid: String(itemId),
              vals: cleaned, // object, not string
            });
            alert("Update succeeded via JSON!");
            return;
          } catch (err) {
            const msg = (err && err.message) || "";
            const more = (err?.graphQLErrors || []).map(e => e?.message).join(" | ");
            console.log("JSON path failed:", msg, more);

            const typeIssue =
              /expecting type "JSON!"/i.test(msg + " " + more) ||
              /Variable .* of type "String!" used in position expecting type "JSON!"/i.test(msg + " " + more) ||
              /INTERNAL_SERVER_ERROR/i.test(more);

            if (!typeIssue) throw err;
          }

          // --- Fallback: String
          const mStr = `
            mutation($bid: ID!, $iid: ID!, $s: String!) {
              change_multiple_column_values(board_id: $bid, item_id: $iid, column_values: $s) { id }
            }`;
          await runGql("set-columns(String)", mStr, {
            bid: String(boardId),
            iid: String(itemId),
            s: JSON.stringify(cleaned),
          });
          alert("Update succeeded via String fallback!");
        } catch (e) {
          console.error("Update failed:", e);
          alert("Update failed. Check console.");
        }
      }

      document.getElementById("applyBtn").addEventListener("click", applyToMonday);
    });
  </script>
</body>
</html>
