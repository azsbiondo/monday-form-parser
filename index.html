<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form Parser</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/monday-sdk-js/dist/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{--bg:#0b0c0f;--card:rgba(255,255,255,.06);--text:#eaeef6;--muted:#aab2c5;--accent:#3d6317;--accent-2:#24468E;--border:rgba(255,255,255,.12);--shadow:0 10px 25px rgba(0,0,0,.35)}
@media (prefers-color-scheme: light){:root{--bg:#f6f7fb;--card:#ffffff;--text:#0b0c0f;--muted:#5a6173;--accent:#3d6317;--accent-2:#24468E;--border:rgba(10,12,16,.08);--shadow:0 10px 25px rgba(10,12,16,.08)}}
html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:
  radial-gradient(1200px 600px at 20% -10%,rgba(36,70,142,.25),transparent 60%),
  radial-gradient(900px 450px at 120% 20%,rgba(61,99,23,.20),transparent 60%),var(--bg);color:var(--text)}
.container{max-width:980px;margin:24px auto;padding:0 20px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.title{font-size:20px;font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:linear-gradient(135deg,var(--accent-2),var(--accent));color:#fff}
.panel{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:14px 14px 0 14px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));color:var(--text);border:1px solid var(--border);transition:transform .05s ease,box-shadow .2s ease,border-color .2s ease}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.18)}
.btn.primary{background:linear-gradient(135deg,var(--accent-2),var(--accent));color:#fff;border-color:transparent}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.statusline{font-size:12px;color:var(--muted);padding:0 14px 10px 14px}
.body{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:14px}
@media (max-width:940px){.body{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:14px;padding:14px;min-height:180px}
.card h2{font-size:14px;margin:0 0 10px 0;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}
.drop{display:flex;align-items:center;justify-content:center;text-align:center;border:2px dashed var(--border);border-radius:14px;height:156px;padding:10px;transition:border-color .2s ease,background .2s ease}
.drop.k{border-color:var(--accent-2);background:rgba(36,70,142,.06)}
.preview{max-height:310px;overflow:auto}
.row{display:grid;grid-template-columns:200px 1fr;gap:10px;padding:8px;border-bottom:1px dashed var(--border);align-items:center}
.key{font-weight:700}
.input, select, .time-part{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--text)}
select{appearance:none}
.kv-empty{color:var(--muted)}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpill{font-size:12px;border-radius:999px;padding:6px 10px;border:1px solid var(--border);color:var(--muted)}
.footer-note{font-size:11px;color:var(--muted);padding:10px 14px 16px 14px}
hr.sep{border:0;border-top:1px solid var(--border);margin:10px 0}
.hint{font-size:12px;color:var(--muted);margin-top:6px}
.hide{display:none!important}
.inline{display:flex;gap:8px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.switch{position:relative;width:44px;height:24px;border-radius:999px;background:rgba(255,255,255,.2);border:1px solid var(--border);cursor:pointer;display:inline-block;vertical-align:middle}
.switch::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:999px;background:#fff;transition:left .15s ease}
.switch.on{background:linear-gradient(135deg,var(--accent-2),var(--accent));border-color:transparent}
.switch.on::after{left:24px}
.time-part[disabled], select[disabled]{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">Form → Columns <span class="badge">Item View</span></div>
    <div class="kpi">
      <div class="kpill" id="theme-pill">Theme: auto</div>
      <div class="kpill" id="ctx-pill">Board: — | Item: —</div>
    </div>
  </div>
  <div class="panel">
    <div class="toolbar">
      <div class="actions">
        <button class="btn hide" id="extract">Extract from attachment</button>
        <button class="btn primary" id="apply" disabled>Apply to item</button>
      </div>
      <div class="actions">
        <button class="btn" id="choose">Choose .docx</button>
      </div>
    </div>
    <div class="statusline" id="msg">Drop a .docx below or click “Choose .docx”.</div>
    <div class="body">
      <div class="card">
        <h2>Dropzone</h2>
        <div id="dropzone" class="drop">Drag & drop a .docx here</div>
        <input id="fileinput" type="file" accept=".docx" style="display:none">
        <div class="hint">Only the mapped fields will be applied to Monday. You can edit values on the right before applying.</div>
        <hr class="sep">
        <div class="footer-note">All processing stays in your browser; only column updates are sent to Monday.</div>
      </div>
      <div class="card">
        <h2>Preview & Modify</h2>
        <div id="preview" class="preview kv-empty">No fields extracted yet.</div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const monday = mondaySdk();

  // ====== Mapped columns (only these are sent) ======
  const mapping={
    "Value":{"type":"numbers","columnId":"numeric_mkq0534"},
    "Team_Lead":{"type":"text","columnId":"executive___ops_2"},
    "Team_Est":{"type":"text","columnId":"text8"}
  };

  // ====== Friendly labels & order ======
  const FRIENDLY={
    ENumber:"E Number",
    Name_Client:"Client",
    Name_Project:"Project",
    Due_Date:"Due date",
    Due_Time:"Due time",
    Group:"Group / Discipline",
    status06:"Status (status06)",
    Value:"Value",
    Team_Lead:"Team Lead",
    Team_Est:"Team Estimate"
  };
  const ORDER=[
    "ENumber","Name_Client","Name_Project",
    "Due_Date","Due_Time","Group","status06",
    "Value","Team_Lead","Team_Est"
  ];

  // ====== Ignore (do not show / do not use) ======
  const IGNORED = new Set(["Name_Requester","Date_Request","Deliv_Format"]);
  const SPECIAL_USED = new Set(["ENumber","Name_Client","Name_Project","Due_Date","Due_Time","Group"]);

  // ====== Status options (fixed, theme-safe) ======
  const STATUS_OPTIONS=["","SPC","ENG","MAJ"]; // "" => (none)

  // ====== Auto-map Group -> status06 label ======
  function mapGroupToStatusLabel(v){
    if(!v) return "";
    const s=String(v).trim();
    const setSPC=new Set(["CSA","Mechanical","Electrical","Insulation","Fabrication","Telecom","Energy Management"]);
    if(setSPC.has(s)) return "SPC";
    if(s==="Design") return "ENG";
    if(/^Major/i.test(s)) return "MAJ";
    return "";
  }

  // ====== Normalizers ======
  function setMsg(t){document.getElementById("msg").innerText=t||""}
  function showErr(e,label){const msg=(e&&e.message)?e.message:String(e||"Unknown error");setMsg(label+": "+msg);console.error(label,e)}
  function withTimeout(promise,ms,label){let t;const timeout=new Promise((_,rej)=>{t=setTimeout(()=>rej(new Error(label+" timed out after "+ms+"ms")),ms)});return Promise.race([promise,timeout]).finally(()=>clearTimeout(t))}
  function normText(s){return (s||"").trim()}
  function normDate(s){if(!s)return null;const d=new Date(s);return isNaN(d)?null:d.toISOString().slice(0,10)}

  // Parse to HH:MM (24h); clamp minutes to 00/30
  function parseTimeToHHMM(s){
    if(!s) return null;
    const str=String(s).trim();
    const m=str.match(/^(\d{1,2})(?::?(\d{2}))?\s*([AaPp][Mm])?$/);
    if(m){
      let hh=parseInt(m[1],10);
      let mm=m[2]?parseInt(m[2],10):0;
      const ap=m[3]?.toLowerCase?.();
      if(ap==="pm"&&hh<12) hh+=12;
      if(ap==="am"&&hh===12) hh=0;
      if(hh<0||hh>23) return null;
      mm = mm>=30 ? 30 : 0;
      return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
    }
    const d=new Date("1970-01-01T"+str);
    if(isNaN(d)) return null;
    let hh=d.getHours(), mm=d.getMinutes();
    mm = mm>=30 ? 30 : 0;
    return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
  }

  // ====== DOCX unzip & extract (SDT tags) ======
  async function parseDocxArrayBuffer(ab){
    const zip=await withTimeout(JSZip.loadAsync(ab),10000,"Unzipping .docx");
    const f=zip.file("word/document.xml");
    if(!f) throw new Error("word/document.xml not found (is this a valid .docx?)");
    return await withTimeout(f.async("string"),8000,"Reading document.xml");
  }
  function textFromNode(node){
    const walker=document.createTreeWalker(node,NodeFilter.SHOW_TEXT,null);
    let t="",curr; while((curr=walker.nextNode())) t+=curr.nodeValue; return t;
  }
  function extractSdtWithDOM(documentXml){
    const dom=new DOMParser().parseFromString(documentXml,"application/xml");
    if(dom.getElementsByTagName("parsererror").length){throw new Error("XML parsererror in document.xml")}
    const all=dom.getElementsByTagName("*"); const out={};
    for(let i=0;i<all.length;i++){
      const el=all[i]; if(el.localName!=="sdt") continue;
      let pr=null,content=null;
      for(let j=0;j<el.childNodes.length;j++){
        const ch=el.childNodes[j];
        if(ch.nodeType===1 && ch.localName==="sdtPr") pr=ch;
        if(ch.nodeType===1 && ch.localName==="sdtContent") content=ch;
      }
      if(!pr||!content) continue;
      let tag=null;
      const tags=pr.getElementsByTagName("*");
      for(let k=0;k<tags.length;k++){
        const t=tags[k];
        if(t.localName==="tag"||t.localName==="alias"){
          tag=t.getAttribute("w:val")||t.getAttribute("val");
          if(tag) break;
        }
      }
      if(!tag) continue;
      const value=normText(textFromNode(content));
      out[tag]=value;
    }
    return out;
  }

  // ====== Business rules ======
  function buildTitle(fields){
    const a=normText(fields.ENumber), b=normText(fields.Name_Client), c=normText(fields.Name_Project);
    const parts=[a,b,c].filter(Boolean);
    return parts.length? parts.join(" ") : null;
  }

  // ====== State ======
  let ctx=null,itemId=null,boardId=null;
  let rawFields={}, editedFields={}, updates=null, pendingName=null;
  let uiState={ timeEnabled:false, hour:"00", minute:"00", status:"", statusTouched:false };

  // ====== UI: editable preview in your required order/labels ======
  function renderEditablePreview(allFields){
    const el=document.getElementById("preview");
    // start from extracted but drop ignored
    const filtered={};
    Object.keys(allFields||{}).forEach(k=>{ if(!IGNORED.has(k)) filtered[k]=allFields[k]; });

    if(Object.keys(filtered).length===0){
      el.classList.add("kv-empty"); el.innerHTML="No fields extracted yet."; return;
    }
    el.classList.remove("kv-empty");

    // seed editedFields
    editedFields = {...filtered};

    // seed time + status UI state from fields
    const hhmm=parseTimeToHHMM(filtered.Due_Time);
    if(hhmm){
      uiState.timeEnabled=true;
      uiState.hour=hhmm.split(":")[0];
      uiState.minute=hhmm.split(":")[1];
    }else{
      uiState.timeEnabled=false;
      uiState.hour="00"; uiState.minute="00";
    }
    const autoStatus=mapGroupToStatusLabel(filtered.Group);
    uiState.status = autoStatus || ""; // default from Group; user can change
    uiState.statusTouched = false;

    // build rows in ORDER with special widgets
    const rows = ORDER.map(key=>{
      const label=FRIENDLY[key]||key;
      if(key==="Due_Date"){
        const val=(normDate(filtered.Due_Date)||"");
        return rowTpl(label, `<input type="date" class="input" data-key="Due_Date" value="${val}">`);
      }
      if(key==="Due_Time"){
        // time toggle + HH/MM selects
        const onClass=uiState.timeEnabled?"on":"";
        const disabled = uiState.timeEnabled? "" : "disabled";
        const hourOpts = Array.from({length:24},(_,h)=>String(h).padStart(2,"0"))
          .map(h=>`<option value="${h}" ${h===uiState.hour?"selected":""}>${h}</option>`).join("");
        const minOpts = ["00","30"].map(m=>`<option value="${m}" ${m===uiState.minute?"selected":""}>${m}</option>`).join("");
        return rowTpl(label, `
          <div class="inline">
            <span id="timeSwitch" class="switch ${onClass}" role="switch" aria-checked="${uiState.timeEnabled}" title="Toggle time"></span>
            <div class="inline" style="flex:1">
              <select id="hh" class="time-part" ${disabled}>${hourOpts}</select>
              <span class="small">:</span>
              <select id="mm" class="time-part" ${disabled}>${minOpts}</select>
              <span class="small">24-hour, minutes 00/30</span>
            </div>
          </div>
        `);
      }
      if(key==="status06"){
        const opts = STATUS_OPTIONS.map(s=>{
          const lbl = s==="" ? "(none)" : s;
          const sel = (s===uiState.status) ? "selected" : "";
          return `<option value="${s}" ${sel}>${lbl}</option>`;
        }).join("");
        return rowTpl(label, `<select id="statusSelect">${opts}</select>`);
      }
      // default text/number input fields
      const current = (filtered[key]||"").replace(/"/g,'&quot;');
      return rowTpl(label, `<input class="input" data-key="${key}" value="${current}">`);
    }).join("");

    el.innerHTML = rows;

    // wire generic text inputs
    el.querySelectorAll("input.input").forEach(inp=>{
      inp.addEventListener("input", e=>{
        const k=e.target.getAttribute("data-key");
        editedFields[k]=e.target.value;
        // Live auto-map status when Group changes (unless user already touched status)
        if(k==="Group" && !uiState.statusTouched){
          const auto=mapGroupToStatusLabel(e.target.value);
          uiState.status = auto || "";
          const sel=document.getElementById("statusSelect");
          if(sel){ sel.value = uiState.status; }
        }
      });
    });

    // wire date
    const dateInp=el.querySelector('input[data-key="Due_Date"]');
    if(dateInp){
      dateInp.addEventListener("change", e=>{
        editedFields.Due_Date=e.target.value;
      });
    }

    // wire time switch + selects
    const sw=document.getElementById("timeSwitch");
    const hhSel=document.getElementById("hh");
    const mmSel=document.getElementById("mm");
    function setTimeEnabled(on){
      uiState.timeEnabled=on;
      sw.classList.toggle("on", on);
      sw.setAttribute("aria-checked", String(on));
      hhSel.disabled = !on; mmSel.disabled=!on;
      if(!on){ editedFields.Due_Time=""; }  // clear time
      else{
        // write current HH:MM back
        editedFields.Due_Time = uiState.hour+":"+uiState.minute;
      }
    }
    sw.addEventListener("click", ()=> setTimeEnabled(!uiState.timeEnabled));
    hhSel.addEventListener("change", e=>{
      uiState.hour=e.target.value;
      if(uiState.timeEnabled) editedFields.Due_Time=uiState.hour+":"+uiState.minute;
    });
    mmSel.addEventListener("change", e=>{
      uiState.minute=e.target.value;
      if(uiState.timeEnabled) editedFields.Due_Time=uiState.hour+":"+uiState.minute;
    });

    // wire status select
    const statusSel=document.getElementById("statusSelect");
    if(statusSel){
      statusSel.addEventListener("change", e=>{
        uiState.statusTouched = true;
        uiState.status = e.target.value; // "" or label
      });
    }
  }

  function rowTpl(label, controlHtml){
    return `<div class="row">
      <div class="key">${label}</div>
      <div>${controlHtml}</div>
    </div>`;
  }

  // ====== Build updates payload from edited + UI state ======
  async function buildUpdatesFromEdited(fields){
    const vals={};

    // Title
    pendingName = buildTitle(fields) || null;

    // date6 with optional time
    const dateIso = normDate(normText(fields.Due_Date));
    let hhmm = null;
    if(uiState.timeEnabled){
      // ensure HH:MM and 00/30 minutes
      const clamped = (uiState.hour||"00")+":"+(uiState.minute||"00");
      hhmm = parseTimeToHHMM(clamped);
    }
    if(dateIso){
      vals["date6"] = hhmm ? {"date":dateIso,"time":hhmm} : {"date":dateIso};
    }

    // status06 from dropdown (or auto if empty)
    const chosen = uiState.status || mapGroupToStatusLabel(fields.Group);
    if(chosen){ vals["status06"]={label:chosen}; }

    // mapped columns
    for(const k in mapping){
      const m=mapping[k];
      const v=fields[k];
      if(v==null || v==="") continue;
      if(m.type==="text"){ vals[m.columnId]=v; }
      else if(m.type==="numbers"){
        const n=Number(String(v).replace(/[^0-9.\-]/g,""));
        if(!isNaN(n)) vals[m.columnId]=String(n);
      }
    }
    return vals;
  }

  // ====== Apply to monday (IDs as ID!, pass JSON as var) ======
  async function applyToMonday(vals){
    const m=`mutation($b:ID!,$i:ID!,$v:JSON!){
      change_multiple_column_values(board_id:$b,item_id:$i,column_values:$v){ id }
    }`;
    const resp = await monday.api(m,{ variables:{ b:String(boardId), i:String(itemId), v: JSON.stringify(vals) }});
    if(resp.errors && resp.errors.length){
      const msg = resp.errors.map(e=>e.message).join("; ");
      throw new Error("column_values: " + msg);
    }

    if(pendingName){
      try{
        const m2=`mutation($i:ID!,$val:String!){
          change_simple_column_value(item_id:$i,column_id:"name", value:$val){ id }
        }`;
        const r2 = await monday.api(m2,{ variables:{ i:String(itemId), val: pendingName }});
        if(r2.errors && r2.errors.length){ throw new Error(r2.errors.map(e=>e.message).join("; ")) }
      }catch(e){
        const m3=`mutation($i:ID!,$name:String!){
          change_item_name(item_id:$i, name:$name){ id }
        }`;
        const r3 = await monday.api(m3,{ variables:{ i:String(itemId), name: pendingName }});
        if(r3.errors && r3.errors.length){ throw new Error("change_item_name: " + r3.errors.map(er=>er.message).join("; ")) }
      }
    }
  }

  // ====== Monday context/theme ======
  monday.listen("context",(res)=>{const c=res.data||{};ctx=c;itemId=c.itemId;boardId=c.boardId;document.getElementById("ctx-pill").innerText=`Board: ${boardId||"—"} | Item: ${itemId||"—"}`});
  monday.listen("theme",(res)=>{const theme=res.data?.theme||"auto";document.getElementById("theme-pill").innerText=`Theme: ${theme}`});

  // ====== UI bindings ======
  const dz=document.getElementById("dropzone"), fi=document.getElementById("fileinput");
  document.getElementById("choose").onclick=()=>fi.click();
  fi.addEventListener("change",e=>{
    const f=e.target.files?.[0];
    if(f && /\.docx$/i.test(f.name)) handleLocalFile(f); else setMsg("Please choose a .docx");
  });
  dz.addEventListener("dragover",e=>{e.preventDefault();dz.classList.add("k")});
  dz.addEventListener("dragleave",e=>{e.preventDefault();dz.classList.remove("k")});
  dz.addEventListener("drop",e=>{
    e.preventDefault();dz.classList.remove("k");
    const f=e.dataTransfer.files?.[0];
    if(!f){setMsg("No file dropped");return}
    if(!/\.docx$/i.test(f.name)){setMsg("Please drop a .docx file");return}
    handleLocalFile(f);
  });

  document.getElementById("apply").onclick=async()=>{
    try{
      if(!editedFields || Object.keys(editedFields).length===0){ setMsg("Nothing to apply"); return }
      setMsg("Building updates…");
      // strip ignored
      const working={};
      Object.keys(editedFields).forEach(k=>{ if(!IGNORED.has(k)) working[k]=editedFields[k]; });
      updates = await buildUpdatesFromEdited(working);
      if(Object.keys(updates).length===0 && !buildTitle(working)){ setMsg("Nothing mappable found"); return; }
      setMsg("Updating item…");
      await applyToMonday(updates);
      setMsg("Done");
    }catch(e){ showErr(e,"Update failed"); }
  };

  // ====== Flow: local file ======
  async function handleLocalFile(file){
    try{
      setMsg(`Reading local .docx… (${(file.size/1024/1024).toFixed(2)} MB)`);
      const ab=await withTimeout(file.arrayBuffer(),8000,"Loading file");
      const xml=await parseDocxArrayBuffer(ab);
      setMsg("Parsing fields…");
      rawFields = extractSdtWithDOM(xml);
      renderEditablePreview(rawFields);
      const hasAny = Object.keys(rawFields).some(k=>!IGNORED.has(k));
      document.getElementById("apply").disabled = !hasAny;
      setMsg(hasAny? "Ready to apply" : "Nothing mappable found");
    }catch(e){ showErr(e,"Could not read .docx"); }
  }

  // global errors
  window.addEventListener("error",(e)=> showErr(e.error||e.message,"Script error"));
});
</script>
</body>
</html>
