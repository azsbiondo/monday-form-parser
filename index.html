<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Update Monday Item</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Monday SDK -->
  <script src="https://cdn.jsdelivr.net/npm/monday-sdk-js/dist/main.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    button { padding: 10px 14px; border-radius: 8px; border: 0; cursor: pointer; }
    .ok { background: #0fa958; color: white; }
    .warn { background: #f2c94c; }
    pre { background: #f7f7f7; padding: 12px; border-radius: 8px; overflow: auto; }
  </style>
</head>
<body>
  <h2>Apply values to this item</h2>
  <p>This demo updates the current item’s <b>status06</b> (Group) and <b>date6</b> (Due Date). Add other columns in <code>buildColumnValues()</code>.</p>
  <button id="apply" class="ok">Apply to Monday</button>
  <div id="out" style="margin-top:16px;"></div>

  <script>
    // 1) Initialize SDK (note: mondaySdk, not mondaySDK)
    const monday = window.mondaySdk();

    // Helper: map your free-text "Group" to status06 labels
    function normalizeGroupLabel(raw) {
      if (!raw) return null;
      const s = String(raw).trim().toUpperCase();
      // Allowed labels per your board: SPC / ENG / MAJ / MKT / TBD
      if (["SPC","SPEC","SPECIAL"].includes(s)) return "SPC";
      if (["ENG","ENGINEERING"].includes(s)) return "ENG";
      if (["MAJ","MAJOR"].includes(s)) return "MAJ";
      if (["MKT","MARKETING"].includes(s)) return "MKT";
      if (["TBD","UNKNOWN","NA","N/A"].includes(s)) return "TBD";
      // Default/fallback: keep only valid ones, otherwise null to avoid validation errors
      return null;
    }

    // Helper: build the JSON object you want to send to change_multiple_column_values
    function buildColumnValues({ groupText, dueDateISO, dueTime24 }) {
      const colVals = {};

      // status06 (your Group column)
      const label = normalizeGroupLabel(groupText);
      if (label) {
        colVals["status06"] = { label };   // <-- your confirmed status column id
      }

      // date6 (your Date column) — time is optional on Monday's date columns
      if (dueDateISO) {
        if (dueTime24) {
          colVals["date6"] = { date: dueDateISO, time: dueTime24 }; // "YYYY-MM-DD", "HH:mm:ss"
        } else {
          colVals["date6"] = { date: dueDateISO };
        }
      }

      // EXAMPLES for adding more columns safely:
      // colVals["text0"] = "Some text";
      // colVals["numbers2"] = 123.45;
      // colVals["status3"] = { label: "Done" };
      // colVals["person4"] = { personsAndTeams: [{ id: 12345678, kind: "person" }] };

      return colVals;
    }

    // 2) Get context (board/item) from Monday
    let ctx = null;
    monday.listen("context", (res) => {
      ctx = res.data;
      // You typically have: ctx.boardId, ctx.itemId (in an Item view)
      console.log("[Context]", ctx);
    });

    // 3) Click handler: perform the mutation with monday.api()
    document.getElementById("apply").addEventListener("click", async () => {
      const out = document.getElementById("out");
      out.innerHTML = "";

      try {
        // Require context
        const boardId = ctx?.boardId;
        const itemId  = ctx?.itemId;
        if (!boardId || !itemId) {
          throw new Error("No boardId/itemId in context. Open this inside a Monday item view.");
        }

        // TODO: Replace these with your real parsed values
        // Example placeholders:
        const groupText = "SPC";           // e.g., parsed from your Word doc
        const dueDateISO = "2025-09-15";   // "YYYY-MM-DD"
        const dueTime24 = "13:00:00";      // optional "HH:mm:ss" (omit to set date only)

        const colValsObj = buildColumnValues({ groupText, dueDateISO, dueTime24 });

        // IMPORTANT: column_values must be sent as a JSON STRING
        const columnValsString = JSON.stringify(colValsObj);

        const mutation = `
          mutation ChangeVals($boardId: Int!, $itemId: Int!, $columnVals: JSON!) {
            change_multiple_column_values(
              board_id: $boardId,
              item_id: $itemId,
              column_values: $columnVals
            ) {
              id
            }
          }
        `;

        const variables = {
          boardId,
          itemId,
          columnVals: columnValsString
        };

        const resp = await monday.api(mutation, { variables });
        console.log("[GQL Response]", resp);

        if (resp.error || resp.errors) {
          throw new Error((resp.error?.message) || (resp.errors && resp.errors[0] && resp.errors[0].message) || "Unknown GraphQL error");
        }

        out.innerHTML = `<div>✅ Updated item <b>${itemId}</b> on board <b>${boardId}</b>.</div>
        <details><summary>Sent column_values</summary><pre>${columnValsString}</pre></details>`;
      } catch (err) {
        console.error(err);
        out.innerHTML = `<div class="warn">❌ Update failed:<br>${err?.message || err}</div>`;
      }
    });
  </script>
</body>
</html>
