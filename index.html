<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form Parser</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/monday-sdk-js/dist/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{
  --bg:#0b0c0f;--card:rgba(255,255,255,.06);--text:#eaeef6;--muted:#aab2c5;
  --accent:#3d6317;--accent-2:#24468E;--border:rgba(255,255,255,.12);
  --shadow:0 10px 25px rgba(0,0,0,.35);
  --field-bg:rgba(255,255,255,.05); --field-text:var(--text);
  --select-bg:#11141a; --select-text:#eaeef6; --option-bg:#11141a; --option-text:#eaeef6;
}
@media (prefers-color-scheme: light){
  :root{
    --bg:#f6f7fb;--card:#ffffff;--text:#0b0c0f;--muted:#5a6173;
    --accent:#3d6317;--accent-2:#24468E;--border:rgba(10,12,16,.08);
    --shadow:0 10px 25px rgba(10,12,16,.08);
    --field-bg:#fff; --field-text:#0b0c0f;
    --select-bg:#ffffff; --select-text:#0b0c0f; --option-bg:#ffffff; --option-text:#0b0c0f;
  }
}
html,body{height:100%}
body{
  margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:
    radial-gradient(1200px 600px at 20% -10%,rgba(36,70,142,.25),transparent 60%),
    radial-gradient(900px 450px at 120% 20%,rgba(61,99,23,.20),transparent 60%),
    var(--bg);
  color:var(--text)
}
/* slightly narrower so Monday doesn’t show horizontal scroll */
.container{max-width:860px;margin:24px auto;padding:0 12px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.title{font-size:20px;font-weight:800;letter-spacing:.2px;display:flex;gap:10px;align-items:center}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:linear-gradient(135deg,var(--accent-2),var(--accent));color:#fff}
.panel{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:14px 14px 0 14px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));color:var(--text);border:1px solid var(--border);transition:transform .05s ease,box-shadow .2s ease,border-color .2s ease}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.18)}
.btn.primary{background:linear-gradient(135deg,var(--accent-2),var(--accent));color:#fff;border-color:transparent}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.statusline{font-size:12px;color:var(--muted);padding:0 14px 10px 14px}
.body{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:14px}
@media (max-width:940px){.body{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:14px;padding:14px;min-height:180px}
.card h2{font-size:14px;margin:0 0 10px 0;letter-spacing:.3px;text-transform:uppercase;color:var(--muted)}
.drop{display:flex;align-items:center;justify-content:center;text-align:center;border:2px dashed var(--border);border-radius:14px;height:156px;padding:10px;transition:border-color .2s ease,background .2s ease}
.drop.k{border-color:var(--accent-2);background:rgba(36,70,142,.06)}
.preview{max-height:310px;overflow:auto}
.row{display:grid;grid-template-columns:210px 1fr;gap:10px;padding:8px;border-bottom:1px dashed var(--border);align-items:center}
.key{font-weight:700}
.input, select, .timewrap select, .timewrap input[type="checkbox"]{
  width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);
  background:var(--field-bg);color:var(--field-text)
}
/* force high-contrast selects/options in both themes */
select, .timewrap select{
  background:var(--select-bg)!important;color:var(--select-text)!important;
}
select option, .timewrap select option{
  background:var(--option-bg)!important;color:var(--option-text)!important;
}
.kv-empty{color:var(--muted)}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpill{font-size:12px;border-radius:999px;padding:6px 10px;border:1px solid var(--border);color:var(--muted)}
.hint{font-size:12px;color:var(--muted);margin-top:6px}
.hide{display:none!important}
.timewrap{display:flex;gap:8px;align-items:center}
.toggle{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
.toggle input{width:auto}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">Form → Columns <span class="badge">Item View</span></div>
    <div class="kpi">
      <div class="kpill" id="theme-pill">Theme: auto</div>
      <div class="kpill" id="ctx-pill">Board: — | Item: —</div>
    </div>
  </div>
  <div class="panel">
    <div class="toolbar">
      <div class="actions">
        <button class="btn hide" id="extract">Extract from attachment</button>
        <button class="btn primary" id="apply" disabled>Apply to item</button>
      </div>
      <div class="actions">
        <button class="btn" id="choose">Choose .docx</button>
      </div>
    </div>
    <div class="statusline" id="msg">Drop a .docx below or click “Choose .docx”.</div>
    <div class="body">
      <div class="card">
        <h2>Dropzone</h2>
        <div id="dropzone" class="drop">Drag and drop the Estimate Engagement form here.</div>
        <input id="fileinput" type="file" accept=".docx" style="display:none">
      </div>
      <div class="card">
        <h2>Preview & Modify</h2>
        <div id="preview" class="preview kv-empty">No fields extracted yet.</div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const monday = mondaySdk();

  // ====== Column mapping (send ONLY these) ======
  const mapping = {
    "Value":      { type:"numbers", columnId:"numeric_mkq0534" },
    "Team_Lead":  { type:"text",    columnId:"executive___ops_2" }, // Assigned Lead
    "Team_Est":   { type:"text",    columnId:"text8" },             // Estimating Lead
    "PM_Lead":    { type:"text",    columnId:"text0" }              // New PM Lead (blank by default)
  };

  // ====== Special rules / sets ======
  const IGNORED = new Set(["Name_Requester","Date_Request","Deliv_Format"]);
  const allowedGroupLabels = ["SPC","ENG","MAJ"]; // fixed Monday status labels
  // map many docx group/discipline values to those three:
  function mapGroupToStatusLabel(v){
    if(!v) return null;
    const s = String(v).trim();

    // already a valid label?
    if (allowedGroupLabels.includes(s)) return s;

    // buckets → SPC
    const spcSet = new Set(["CSA","Mechanical","Electrical","Insulation","Fabrication","Telecom","Energy Management","Instrumentation","Piping","Civil","Structural"]);
    if (spcSet.has(s)) return "SPC";

    // buckets → ENG
    if (/^Design$/i.test(s) || /^Engineering$/i.test(s) || /^ENG$/i.test(s)) return "ENG";

    // buckets → MAJ
    if (/^Major/i.test(s) || /^MAJ$/i.test(s)) return "MAJ";

    return null; // unknown -> user picks in UI
  }

  // ====== State ======
  let ctx=null, itemId=null, boardId=null;
  let rawFields={}, editedFields={}, updates=null, pendingName=null;

  // ====== UI helpers ======
  function setMsg(t){document.getElementById("msg").innerText=t||""}
  function showErr(e,label){const msg=(e&&e.message)?e.message:String(e||"Unknown error");setMsg(label+": "+msg);console.error(label,e)}
  function withTimeout(promise,ms,label){let t;const timeout=new Promise((_,rej)=>{t=setTimeout(()=>rej(new Error(label+" timed out after "+ms+"ms")),ms)});return Promise.race([promise,timeout]).finally(()=>clearTimeout(t))}
  function normText(s){return (s||"").trim()}
  function normDateToYMD(s){
    if(!s) return "";
    // try ISO first
    const d1 = new Date(s);
    if(!isNaN(d1)) return d1.toISOString().slice(0,10);
    // try mm/dd/yy or mm/dd/yyyy
    const m = String(s).match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if(m){
      const mm = m[1].padStart(2,"0");
      const dd = m[2].padStart(2,"0");
      let yyyy = m[3];
      if(yyyy.length===2){ yyyy = (Number(yyyy) < 70 ? "20"+yyyy : "19"+yyyy); }
      return `${yyyy}-${mm}-${dd}`;
    }
    return "";
  }
  function parseTimeToHHMM(s){
    if(!s) return null;
    const str = String(s).trim();
    const m = str.match(/^(\d{1,2})(?::?(\d{2}))?\s*([AaPp][Mm])?$/);
    if(!m){
      const d=new Date("1970-01-01T"+str);
      if(!isNaN(d)) return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
      return null;
    }
    let hh=parseInt(m[1],10),mm=m[2]?parseInt(m[2],10):0,ap=m[3]?.toLowerCase?.();
    if(ap==="pm"&&hh<12) hh+=12;
    if(ap==="am"&&hh===12) hh=0;
    if(hh<0||hh>23||mm<0||mm>59) return null;
    return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
  }

  // ====== DOCX unzip & extract ======
  async function parseDocxArrayBuffer(ab){
    const zip=await withTimeout(JSZip.loadAsync(ab),10000,"Unzipping .docx");
    const f=zip.file("word/document.xml");
    if(!f) throw new Error("word/document.xml not found (is this a valid .docx?)");
    return await withTimeout(f.async("string"),8000,"Reading document.xml");
  }
  function textFromNode(node){
    const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null);
    let t="", curr; while((curr=walker.nextNode())) t += curr.nodeValue; return t;
  }
  function extractSdtWithDOM(documentXml){
    const dom = new DOMParser().parseFromString(documentXml,"application/xml");
    if(dom.getElementsByTagName("parsererror").length){throw new Error("XML parsererror in document.xml")}
    const all = dom.getElementsByTagName("*");
    const out = {};
    for(let i=0;i<all.length;i++){
      const el=all[i]; if(el.localName!=="sdt") continue;
      let pr=null,content=null;
      for(let j=0;j<el.childNodes.length;j++){
        const ch=el.childNodes[j];
        if(ch.nodeType===1 && ch.localName==="sdtPr") pr=ch;
        if(ch.nodeType===1 && ch.localName==="sdtContent") content=ch;
      }
      if(!pr||!content) continue;
      let tag=null;
      const tags=pr.getElementsByTagName("*");
      for(let k=0;k<tags.length;k++){
        const t=tags[k];
        if(t.localName==="tag"||t.localName==="alias"){
          tag = t.getAttribute("w:val") || t.getAttribute("val");
          if(tag) break;
        }
      }
      if(!tag) continue;
      const value = normText(textFromNode(content));
      out[tag]=value;
    }
    return out;
  }

  // ====== Title build ======
  function buildTitle(fields){
    const a=normText(fields.ENumber), b=normText(fields.Name_Client), c=normText(fields.Name_Project);
    const parts=[a,b,c].filter(Boolean);
    return parts.length? parts.join(" ") : null;
  }

  // ====== Preview (friendly labels, fixed order, pickers, proper dropdowns) ======
  function renderEditablePreview(fields){
    const el=document.getElementById("preview");
    const friendlyOrder = [
      ["ENumber","E Number"],
      ["Name_Client","Client"],
      ["Name_Project","Project"],
      // Group (status06) dropdown with fixed labels:
      ["__GroupStatus","Group"],
      // date & time
      ["Due_Date","Due Date"],
      ["Due_Time","Due Time"],
      // Leads
      ["Team_Lead","Assigned Lead"],
      ["PM_Lead","PM Lead"],             // new blank field
      ["Team_Est","Estimating Lead"],
      // Value
      ["Value","Value"]
    ];

    // working copy (start from original, then add computed slots)
    editedFields = {};
    Object.keys(fields||{}).forEach(k=>{
      if(!IGNORED.has(k)) editedFields[k]=fields[k];
    });

    // compute normalized date/time for the inputs
    const dateYMD = normDateToYMD(editedFields.Due_Date);
    const timeHM  = parseTimeToHHMM(editedFields.Due_Time);
    const timeOn  = !!timeHM;

    // compute default mapped status from Group text
    const initialGroup = mapGroupToStatusLabel(editedFields.Group) || "";
    editedFields.__GroupStatus = initialGroup;

    // ensure PM_Lead slot exists (blank initially)
    if (!("PM_Lead" in editedFields)) editedFields.PM_Lead = "";

    // render
    const hourOpts = Array.from({length:24},(_,h)=>`<option value="${String(h).padStart(2,"0")}">${String(h).padStart(2,"0")}</option>`).join("");
    const minuteOpts = ["00","30"].map(m=>`<option value="${m}">${m}</option>`).join("");

    const rowsHtml = friendlyOrder.map(([key,label])=>{
      if(key==="Due_Date"){
        return `
          <div class="row">
            <div class="key">${label}</div>
            <div>
              <input class="input" id="input-date" type="date" value="${dateYMD || ""}">
            </div>
          </div>
        `;
      }
      if(key==="Due_Time"){
        const hh = timeHM ? timeHM.split(":")[0] : "12";
        const mm = timeHM ? timeHM.split(":")[1].padStart(2,"0") : "00";
        return `
          <div class="row">
            <div class="key">${label}</div>
            <div class="timewrap">
              <label class="toggle"><input type="checkbox" id="toggle-time" ${timeOn?"checked":""}> Include time</label>
              <select id="time-hour" ${timeOn?"":"disabled"}>${hourOpts}</select>
              <select id="time-minute" ${timeOn?"":"disabled"}>${minuteOpts}</select>
            </div>
          </div>
          <script>
            (function(){
              const th=document.getElementById('time-hour');
              const tm=document.getElementById('time-minute');
              if(th) th.value='${hh}';
              if(tm) tm.value='${mm}';
            })();
          </script>
        `;
      }
      if(key==="__GroupStatus"){
        const opts = ['<option value=""></option>']
          .concat(allowedGroupLabels.map(l=>`<option value="${l}">${l}</option>`)).join("");
        return `
          <div class="row">
            <div class="key">${label}</div>
            <div><select id="group-status">${opts}</select></div>
          </div>
          <script>(function(){var gs=document.getElementById('group-status'); if(gs) gs.value='${initialGroup}';})();</script>
        `;
      }
      // default text/number inputs
      const val = (editedFields[key]??"").toString().replace(/"/g,'&quot;');
      return `
        <div class="row">
          <div class="key">${label}</div>
          <div><input class="input" data-key="${key}" value="${val}"></div>
        </div>
      `;
    }).join("");

    el.innerHTML = rowsHtml || "No fields extracted yet.";
    el.classList.toggle("kv-empty", !rowsHtml);

    // wiring: generic text inputs
    el.querySelectorAll("input.input").forEach(inp=>{
      inp.addEventListener("input", e=>{
        const key = e.target.getAttribute("data-key");
        editedFields[key] = e.target.value;
      });
    });

    // wiring: group status dropdown
    const groupSel = el.querySelector("#group-status");
    if(groupSel){
      groupSel.addEventListener("change", e=>{
        editedFields.__GroupStatus = e.target.value || "";
      });
    }

    // wiring: time toggle + selects
    const tgl = el.querySelector("#toggle-time");
    const th  = el.querySelector("#time-hour");
    const tm  = el.querySelector("#time-minute");
    if(tgl && th && tm){
      const setEnabled = on => { th.disabled = !on; tm.disabled = !on; };
      setEnabled(tgl.checked);
      tgl.addEventListener("change", ()=> setEnabled(tgl.checked));
      th.addEventListener("change", ()=>{/* live state kept on build */});
      tm.addEventListener("change", ()=>{/* live state kept on build */});
    }

    // wiring: date input
    const di = el.querySelector("#input-date");
    if(di){
      di.addEventListener("change", e=>{
        // store normalized YYYY-MM-DD
        editedFields.Due_Date = e.target.value;
      });
    }
  }

  // ====== Build updates ======
  async function buildUpdatesFromEdited(fields){
    const vals={};

    // Build item name
    pendingName = buildTitle(fields) || null;

    // Date/time
    const dateYMD = normDateToYMD(fields.Due_Date);
    let timeHM = parseTimeToHHMM(fields.Due_Time); // if user typed into generic field
    // prefer picker state if present
    const th = document.getElementById("time-hour");
    const tm = document.getElementById("time-minute");
    const tgl = document.getElementById("toggle-time");
    if(tgl && th && tm){
      if(tgl.checked){
        timeHM = `${th.value}:${tm.value}`;
      }else{
        timeHM = null;
      }
    }
    if(dateYMD){
      vals["date6"] = timeHM ? { date:dateYMD, time:timeHM } : { date:dateYMD };
    }

    // Group/status06 from dropdown/mapper
    let label = fields.__GroupStatus || mapGroupToStatusLabel(fields.Group);
    if(label && allowedGroupLabels.includes(label)){
      vals["status06"] = { label };
    }

    // Regular mapped columns
    for(const k in mapping){
      const m=mapping[k];
      const v=fields[k];
      if(v==null || v==="") continue;
      if(m.type==="text"){ vals[m.columnId]=v; }
      else if(m.type==="numbers"){
        const n=Number(String(v).replace(/[^0-9.\-]/g,""));
        if(!isNaN(n)) vals[m.columnId]=String(n);
      }
    }
    return vals;
  }

  // ====== Apply using JSON! (not string) ======
  async function applyToMonday(vals){
    const mutation = `
      mutation($board_id: ID!, $item_id: ID!, $column_values: JSON!) {
        change_multiple_column_values(board_id:$board_id, item_id:$item_id, column_values:$column_values) { id }
      }
    `;
    const resp = await monday.api(mutation, {
      variables: {
        board_id: String(boardId),
        item_id:  String(itemId),
        column_values: vals
      }
    });
    if (resp.errors && resp.errors.length){
      const msg = resp.errors.map(e => e.message).join("; ");
      throw new Error("column_values: " + msg);
    }

    if(pendingName){
      // best-effort rename via change_item_name
      const m2 = `mutation($item_id: ID!, $name: String!){
        change_item_name(item_id:$item_id, name:$name){ id }
      }`;
      const r2 = await monday.api(m2, { variables:{ item_id:String(itemId), name:pendingName } });
      if (r2.errors && r2.errors.length){
        throw new Error(r2.errors.map(e=>e.message).join("; "));
      }
    }
  }

  // ====== Monday context/theme ======
  monday.listen("context",(res)=>{
    ctx=res.data||{}; itemId=ctx.itemId; boardId=ctx.boardId;
    document.getElementById("ctx-pill").innerText=`Board: ${boardId||"—"} | Item: ${itemId||"—"}`;
  });
  monday.listen("theme",(res)=>{
    const theme=res.data?.theme||"auto";
    document.getElementById("theme-pill").innerText=`Theme: ${theme}`;
  });

  // ====== UI bindings ======
  const dz=document.getElementById("dropzone"), fi=document.getElementById("fileinput");
  document.getElementById("choose").onclick=()=>fi.click();
  fi.addEventListener("change",e=>{
    const f=e.target.files?.[0];
    if(f && /\.docx$/i.test(f.name)) handleLocalFile(f); else setMsg("Please choose a .docx");
  });
  dz.addEventListener("dragover",e=>{e.preventDefault();dz.classList.add("k")});
  dz.addEventListener("dragleave",e=>{e.preventDefault();dz.classList.remove("k")});
  dz.addEventListener("drop",e=>{
    e.preventDefault();dz.classList.remove("k");
    const f=e.dataTransfer.files?.[0];
    if(!f){setMsg("No file dropped");return}
    if(!/\.docx$/i.test(f.name)){setMsg("Please drop a .docx file");return}
    handleLocalFile(f);
  });

  document.getElementById("apply").onclick=async()=>{
    try{
      if(!editedFields || Object.keys(editedFields).length===0){ setMsg("Nothing to apply"); return }
      setMsg("Building updates…");

      const working = {};
      Object.keys(editedFields).forEach(k=>{
        if(!IGNORED.has(k)) working[k] = editedFields[k];
      });

      updates = await buildUpdatesFromEdited(working);
      if(Object.keys(updates).length===0 && !buildTitle(working)){
        setMsg("Nothing mappable found"); return;
      }

      setMsg("Updating item…");
      await applyToMonday(updates);
      setMsg("Done");
    }catch(e){
      showErr(e, "Update failed");
    }
  };

  // ====== Flow: local file ======
  async function handleLocalFile(file){
    try{
      setMsg(`Reading local .docx… (${(file.size/1024/1024).toFixed(2)} MB)`);
      const ab=await withTimeout(file.arrayBuffer(),8000,"Loading file");
      const xml=await parseDocxArrayBuffer(ab);
      setMsg("Parsing fields…");
      rawFields = extractSdtWithDOM(xml);

      const filtered = {};
      Object.keys(rawFields).forEach(k=>{
        if(!IGNORED.has(k)) filtered[k]=rawFields[k];
      });

      renderEditablePreview(filtered);

      const hasAny = Object.keys(filtered).length>0;
      document.getElementById("apply").disabled = !hasAny;
      setMsg(hasAny? "Ready to apply" : "Nothing mappable found");
    }catch(e){ showErr(e,"Could not read .docx") }
  }

  // catch unexpected
  window.addEventListener("error", (e)=> showErr(e.error||e.message, "Script error"));
});
</script>
</body>
</html>
