<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Update status06 & date6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Monday SDK (use CDN, do not self-host) -->
  <script src="https://unpkg.com/monday-sdk-js/dist/main.js"></script>
  <style>
    :root { --gap: 12px; }
    * { box-sizing: border-box; }
    body{font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; padding: 16px;}
    h2{margin: 0 0 6px;}
    .muted{color:#555}
    .row{display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin: 8px 0;}
    label{display:flex; flex-direction:column; font-size:12px; color:#333; gap:6px;}
    input[type="date"], input[type="text"], select {
      padding:8px; border:1px solid #ccc; border-radius:8px; min-width: 180px;
    }
    .time-wrap{display:flex; gap:8px; align-items:center;}
    .time-wrap select { min-width: 100px; }
    button{padding:10px 14px; border:0; border-radius:8px; background:#1f7a54; color:#fff; cursor:pointer}
    button:disabled{opacity:.6; cursor:not-allowed}
    pre{background:#f6f6f6; padding:10px; border-radius:8px; overflow:auto; margin:6px 0 0}
    details{margin-top:8px}
    .ok{color:#117a37}
    .warn{color:#b54708}
    .grid{display:grid; grid-template-columns: 1fr; gap: var(--gap)}
    @media (min-width:720px){ .grid{ grid-template-columns: 1fr 1fr } }
    .pill{display:inline-block; padding:2px 8px; background:#eee; border-radius:999px; font-size:12px}
  </style>
</head>
<body>
  <h2>Update this item</h2>
  <div class="muted">Columns: <span class="pill">status06</span> (Status), <span class="pill">date6</span> (Date)</div>

  <div class="grid" style="margin-top:12px">
    <label>
      Status label (status06)
      <input id="statusLabel" type="text" placeholder="e.g. Done / In Progress / TBD" />
    </label>

    <div class="row" style="align-items:flex-end">
      <label>
        Date (date6)
        <input id="dateOnly" type="date" />
      </label>

      <div class="time-wrap">
        <label>
          Hour (24h)
          <select id="hour">
            <option value="">—</option>
          </select>
        </label>

        <label>
          Minute
          <select id="minute">
            <option value="">—</option>
            <option value="00">00</option>
            <option value="30">30</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <div class="row">
    <button id="btn">Apply</button>
    <span id="hint" class="muted"></span>
  </div>

  <div id="out" style="margin-top:12px"></div>

<script>
/** ---------- SDK / helpers ---------- **/
const monday = window.mondaySdk();
const $ = (id)=>document.getElementById(id);
const out = (html, cls="")=>{
  const d=$("out"), x=document.createElement("div");
  x.className=cls; x.innerHTML=html; d.appendChild(x);
};
const j = (o)=>JSON.stringify(o,null,2);

let context=null;
monday.listen("context", ({data})=>{
  context=data;
  out(`<b>[Context]</b> ${j({boardId:data.boardId, itemId:data.itemId})}`,"muted");
  $("hint").textContent = "Ready";
});

function fillHourOptions(){
  const hour = $("hour");
  // Add 00..23
  for(let h=0; h<=23; h++){
    const v = String(h).padStart(2,"0");
    const opt = document.createElement("option");
    opt.value = v; opt.textContent = v;
    hour.appendChild(opt);
  }
}
fillHourOptions();

async function getBoardColumns(boardId){
  const q=`
    query($ids:[ID!]){
      boards(ids:$ids){
        id
        columns { id title type settings_str }
      }
    }`;
  const r = await monday.api(q,{variables:{ids:String(boardId)}});
  if(r.errors) throw new Error(r.errors[0].message);
  return r.data.boards?.[0]?.columns||[];
}

function parseStatusLabels(settings_str){
  try{
    const s=JSON.parse(settings_str||"{}");
    // labels may come under "labels" (map of index->string) or "labels_positions"
    const raw = s.labels || s.labels_positions || {};
    return Object.values(raw).filter(Boolean).map(x=>String(x));
  }catch{ return []; }
}

function isDateTimeEnabled(settings_str){
  try{
    const s=JSON.parse(settings_str||"{}");
    // Monday may use any of these flags
    return Boolean(s.time || s.enable_time || s.allow_time);
  }catch{ return false; }
}

/**
 * Build the value for the date column.
 * - dateISO is required to include date
 * - time is included only if column has time enabled AND user selected an hour
 * - seconds are always "00"
 */
function buildDateValue(settings_str, dateISO, hourStr, minuteStr){
  if(!dateISO) return null;
  const dtEnabled = isDateTimeEnabled(settings_str);

  if(!dtEnabled) return { date: dateISO }; // never include time if disabled

  // If hour is provided, minute defaults to "00" if empty.
  if(hourStr){
    const hh = hourStr.padStart(2,"0");
    const mm = (minuteStr || "00").padStart(2,"0"); // only "00" or "30" from the UI
    const ss = "00"; // per requirement
    return { date: dateISO, time: `${hh}:${mm}:${ss}` };
  }
  // No hour -> send only date
  return { date: dateISO };
}

async function changeValues(boardId,itemId,valsObj){
  const m = `
    mutation($bid:ID!, $iid:ID!, $vals:JSON!){
      change_multiple_column_values(board_id:$bid, item_id:$iid, column_values:$vals){ id }
    }`;
  const variables = { bid:String(boardId), iid:String(itemId), vals: JSON.stringify(valsObj) };
  out(`<details><summary>Sending column_values</summary><pre>${j(valsObj)}</pre></details>`,"muted");
  const r = await monday.api(m,{variables});
  if(r.errors) throw new Error(r.errors[0].message);
  return r.data.change_multiple_column_values?.id || "ok";
}

/** ---------- Click handler ---------- **/
$("btn").addEventListener("click", async ()=>{
  $("out").innerHTML = "";
  $("hint").textContent = "Working…";
  $("btn").disabled = true;

  try{
    if(!context?.boardId||!context?.itemId) throw new Error("Open this page inside a Monday item view.");

    const boardId=context.boardId, itemId=context.itemId;
    const cols = await getBoardColumns(boardId);

    const statusCol = cols.find(c=>c.id==="status06");
    const dateCol   = cols.find(c=>c.id==="date6");
    if(!dateCol) throw new Error('Column "date6" not found.');

    out(`<b>Columns found</b> ${j({
      status06: statusCol?{id:statusCol.id,title:statusCol.title,type:statusCol.type}:null,
      date6: {id:dateCol.id,title:dateCol.title,type:dateCol.type, timeEnabled:isDateTimeEnabled(dateCol.settings_str)}
    })}`,"muted");

    const vals = {};

    // Status (optional)
    const inputLabel = ($("statusLabel").value||"").trim();
    if(statusCol && inputLabel){
      const allowed = parseStatusLabels(statusCol.settings_str).map(x=>x.toLowerCase());
      if(allowed.includes(inputLabel.toLowerCase())){
        vals["status06"] = { label: inputLabel };
      }else{
        out(`<div class="warn">Label "<b>${inputLabel}</b>" not found on status06. Skipping status update.</div>`,"warn");
      }
    }

    // Date (+ optional time)
    const dateISO = ($("dateOnly").value||"").trim(); // YYYY-MM-DD
    const hourStr = ($("hour").value||"").trim();     // "00".."23" or ""
    const minuteStr = ($("minute").value||"").trim(); // "" or "00" or "30"
    const dateVal = buildDateValue(dateCol.settings_str, dateISO, hourStr, minuteStr);
    if(dateVal) vals["date6"]=dateVal;

    // Nothing to send?
    if(Object.keys(vals).length===0){
      out(`<div class="warn">Nothing to update — provide a Status and/or Date.</div>`,"warn");
      return;
    }

    await changeValues(boardId,itemId,vals);
    out(`<b class="ok">✅ Update succeeded.</b>`,"ok");
  }catch(e){
    out(`<b class="warn">❌ Update failed:</b> ${e?.message||e}`,"warn");
  }finally{
    $("btn").disabled = false;
    $("hint").textContent = "";
  }
});
</script>
</body>
</html>
